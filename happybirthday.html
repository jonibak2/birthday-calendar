<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏–π</title>
  <style>
    :root {
      --bg-color: #f0f0f0;
      --text-color: #333;
      --accent-color: #ff6b6b;
      --card-color: #fff;
    }

    body.dark {
      --bg-color: #1e1e1e;
      --text-color: #eee;
      --accent-color: #ff8c8c;
      --card-color: #2a2a2a;
    }

    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: var(--card-color);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .birthday-form input,
    .birthday-form button {
      padding: 0.5rem;
      margin-right: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .birthday-form button {
      background: var(--accent-color);
      color: white;
      border: none;
      cursor: pointer;
    }

    .birthdays {
      margin-top: 2rem;
    }

    .month-section {
      margin-bottom: 2rem;
    }

    .month-title {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid var(--accent-color);
      padding-bottom: 0.25rem;
    }

    .birthday-card {
      background: var(--card-color);
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 0.5rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--accent-color);
    }

    .theme-toggle {
      cursor: pointer;
    }

    .controls {
      margin-top: 1rem;
    }

    .checkbox-label {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>üéÇ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏–π PG78 üî¥</h1>
    <div class="theme-toggle">üåì</div>
  </header>

  <div class="container">
    <form class="birthday-form">
      <input type="text" id="name" placeholder="–ò–º—è" required />
      <input type="date" id="date" required />
      <label class="checkbox-label"><input type="checkbox" id="noYear" /> –ë–µ–∑ –≥–æ–¥–∞</label>
      <input type="file" id="avatarInput" accept="image/*" />
      <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>

    <div class="controls">
      <button onclick="exportJSON()">üì§ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <input type="file" id="importFile" accept=".json" onchange="importJSON(event)" />
    </div>

    <div class="birthdays" id="birthdays"></div>
  </div>

  <canvas id="canvas" width="64" height="64" style="display:none;"></canvas>

  <script>
    const form = document.querySelector('.birthday-form');
    const birthdaysDiv = document.getElementById('birthdays');
    const themeToggle = document.querySelector('.theme-toggle');
    const avatarInput = document.getElementById('avatarInput');
    const noYearCheckbox = document.getElementById('noYear');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let birthdays = JSON.parse(localStorage.getItem('birthdays') || '[]');
    let avatarBase64 = '';
    let editingIndex = null;

    // Caching keys for avatars
    const avatarStorageKey = 'avatars';

    function saveBirthdays() {
      localStorage.setItem('birthdays', JSON.stringify(birthdays));
    }

    function saveAvatars() {
      localStorage.setItem(avatarStorageKey, JSON.stringify(birthdays.map(b => b.avatar)));
    }

    function loadAvatars() {
      const savedAvatars = JSON.parse(localStorage.getItem(avatarStorageKey) || '[]');
      birthdays.forEach((b, i) => {
        if (savedAvatars[i]) b.avatar = savedAvatars[i];
      });
    }

    function daysUntilNextBirthday(dateStr) {
      const today = new Date();
      const date = new Date(dateStr);
      const month = date.getMonth();
      const day = date.getDate();
      const currentYear = today.getFullYear();
      let next = new Date(currentYear, month, day);
      if (next < today) next.setFullYear(currentYear + 1);
      const diffTime = next - today;
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    function renderBirthdays() {
      birthdaysDiv.innerHTML = '';
      birthdays.sort((a, b) => new Date(a.date).getMonth() - new Date(b.date).getMonth() || new Date(a.date).getDate() - new Date(b.date).getDate());
      const months = [...Array(12)].map((_, i) => new Date(0, i).toLocaleString('ru-RU', { month: 'long' }));
      const grouped = {};
      birthdays.forEach((b, i) => {
        const month = new Date(b.date).getMonth();
        if (!grouped[month]) grouped[month] = [];
        grouped[month].push({ ...b, index: i });
      });

      for (let i = 0; i < 12; i++) {
        if (grouped[i]) {
          const section = document.createElement('div');
          section.className = 'month-section';

          const title = document.createElement('div');
          title.className = 'month-title';
          title.textContent = months[i].charAt(0).toUpperCase() + months[i].slice(1);
          section.appendChild(title);

          grouped[i].forEach(b => {
            const date = new Date(b.date);
            const now = new Date();
            let ageText = '';
            if (!b.noYear) {
              let age = now.getFullYear() - date.getFullYear();
              const upcoming = new Date(now.getFullYear(), date.getMonth(), date.getDate());
              if (now >= upcoming) age++;
              ageText = `(–±—É–¥–µ—Ç ${age} –ª–µ—Ç)`;
            }
            const daysLeft = daysUntilNextBirthday(b.date);
            const card = document.createElement('div');
            card.className = 'birthday-card';
            card.innerHTML = `
              <img class="avatar" src="${b.avatar || 'https://via.placeholder.com/50'}" alt="avatar">
              <div>
                <strong>${b.name}</strong><br />
                üéâ ${date.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long' })} ${ageText}<br />
                ‚è≥ –ß–µ—Ä–µ–∑ ${daysLeft} –¥–Ω.<br />
                <button onclick="editBirthday(${b.index})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button onclick="deleteBirthday(${b.index})">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `;
            section.appendChild(card);
          });

          birthdaysDiv.appendChild(section);
        }
      }
    }

    function deleteBirthday(index) {
      birthdays.splice(index, 1);
      saveBirthdays();
      renderBirthdays();
    }

    function editBirthday(index) {
      const birthday = birthdays[index];
      document.getElementById('name').value = birthday.name;
      document.getElementById('date').value = birthday.date;
      noYearCheckbox.checked = birthday.noYear || false;
      editingIndex = index;
      form.querySelector('button[type="submit"]').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }

    avatarInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      const reader = new FileReader();
      reader.onload = (evt) => {
        img.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const size = Math.min(img.width, img.height);
          const sx = (img.width - size) / 2;
          const sy = (img.height - size) / 2;
          ctx.drawImage(img, sx, sy, size, size, 0, 0, 64, 64);
          avatarBase64 = canvas.toDataURL('image/png');
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const date = document.getElementById('date').value;
      const noYear = noYearCheckbox.checked;
      if (!name || !date) return;

      if (editingIndex !== null) {
        birthdays[editingIndex] = { name, date, noYear, avatar: avatarBase64 || birthdays[editingIndex].avatar };
        editingIndex = null;
        form.querySelector('button[type="submit"]').textContent = '–î–æ–±–∞–≤–∏—Ç—å';
      } else {
        birthdays.push({ name, date, noYear, avatar: avatarBase64 });
      }

      saveBirthdays();
      saveAvatars(); // save avatar data separately
      renderBirthdays();
      form.reset();
      noYearCheckbox.checked = false;
      avatarBase64 = '';
    });

    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
    });

    function exportJSON() {
      const blob = new Blob([JSON.stringify(birthdays, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'birthdays.json';
      link.click();
    }

    function importJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            birthdays = data;
            loadAvatars();
            saveBirthdays();
            saveAvatars();
            renderBirthdays();
          } else {
            alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.');
          }
        } catch (err) {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞.');
        }
      };
      reader.readAsText(file);
    }

    loadAvatars(); // load avatar data
    renderBirthdays();
  </script>
</body>
</html>
